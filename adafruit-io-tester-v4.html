<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Adafruit IO MQTT Full Debug v4</title>
<!-- Official Paho WebSocket client for browsers -->
<script src="https://www.eclipse.org/paho/clients/js/mqttws31.min.js"></script>
<style>
html,body{height:100%;margin:0;padding:0;font-family:sans-serif;background:#0d1117;color:#f0f6fc;}
body{display:flex;flex-direction:column;align-items:center;padding:1em;}
h1,h2{margin:0.5em 0;}
.container{display:flex;flex-wrap:wrap;gap:1em;width:100%;max-width:900px;justify-content:center;}
.panel{flex:1 1 350px;min-width:300px;background:#161b22;border-radius:10px;padding:1em;box-shadow:0 0 10px #0005;}
label{display:block;margin-top:8px;font-size:13px;}
input,button{font-size:14px;padding:8px;border-radius:6px;border:1px solid #30363d;background:#161b22;color:#f0f6fc;}
button{cursor:pointer;}
#status{margin-left:10px;font-size:13px;color:#aaa;}
#buttons button{display:block;width:100%;margin-top:8px;padding:10px;font-size:16px;}
#log{height:400px;overflow:auto;padding:10px;border:1px solid #30363d;border-radius:6px;margin-top:1em;font-size:12px;background:#0d1117;color:#f0f6fc;}
.log-connected{color:lightgreen;}
.log-error{color:red;}
.log-warning{color:orange;}
.log-trace{color:gray;}
@media(max-width:700px){.container{flex-direction:column;}}
</style>
</head>
<body>

<h1>Adafruit IO MQTT Full Debug v4</h1>

<div class="container">
  <div class="panel">
    <h2>Publisher</h2>
    <label>Username: <input id="username" placeholder="your username"></label>
    <label>AIO Key: <input id="key" type="password" placeholder="aio_xxx"></label>
    <label>Feed name: <input id="feed" placeholder="feed name"></label>

    <div style="margin-top:10px">
      <button id="connectBtn">Connect / Disconnect</button>
      <span id="status">Disconnected</span>
    </div>

    <div id="buttons" style="margin-top:1em">
      <button data-msg="BTN_1">Button 1</button>
      <button data-msg="BTN_2">Button 2</button>
      <button data-msg="BTN_3">Button 3</button>
      <button data-msg="BTN_4">Button 4</button>
      <button data-msg="BTN_5">Button 5</button>
      <button data-msg="BTN_6">Button 6</button>
    </div>
  </div>

  <div class="panel">
    <h2>Subscriber / Log</h2>
    <div id="log"></div>
  </div>
</div>

<script>
(function(){
  const urlParams = new URLSearchParams(window.location.search);
  const userInput = document.getElementById("username");
  const keyInput = document.getElementById("key");
  const feedInput = document.getElementById("feed");
  const connectBtn = document.getElementById("connectBtn");
  const statusEl = document.getElementById("status");
  const logEl = document.getElementById("log");
  const buttonsDiv = document.getElementById("buttons");

  if(urlParams.get("user")) userInput.value = urlParams.get("user");
  if(urlParams.get("key")) keyInput.value = urlParams.get("key");
  if(urlParams.get("feed")) feedInput.value = urlParams.get("feed");

  let client = null;
  let connected = false;

  function log(msg,type){
    const line=document.createElement("div");
    if(type) line.className="log-"+type;
    line.textContent="["+new Date().toLocaleTimeString()+"] "+msg;
    logEl.appendChild(line);
    logEl.scrollTop=logEl.scrollHeight;
    console.log(msg);
  }

  function setStatus(text,color){ statusEl.textContent=text; statusEl.style.color=color||"#aaa"; }

  function connect(){
    if(connected){
      client.disconnect();
      connected=false;
      setStatus("Disconnected","orange");
      log("🔌 Disconnected manually","log-warning");
      return;
    }

    const username=userInput.value.trim();
    const key=keyInput.value.trim();
    const feed=feedInput.value.trim();
    if(!username||!key||!feed){ alert("Fill in username, key, feed"); return; }

    const clientId="aio-web-"+Math.random().toString(16).slice(2,10);
    const host="io.adafruit.com";
    const port=443;
    const path="/mqtt";

    log("Creating MQTT client: "+host+":"+port+path+" clientId="+clientId,"log-trace");
    client=new Paho.MQTT.Client(host, port, path, clientId);

    Paho.MQTT.Client.trace=function(txt){ log("[TRACE] "+txt,"log-trace"); };

    client.onConnectionLost=function(res){
      connected=false;
      setStatus("Disconnected","red");
      log("⚠️ Connection lost: "+(res.errorMessage||JSON.stringify(res)),"log-error");
    };
    client.onMessageArrived=function(msg){
      log("📥 Received => topic: "+msg.destinationName+" payload: "+msg.payloadString,"log-connected");
    };

    const topic=username+"/feeds/"+feed;
    const options={
      useSSL:true,
      userName:username,
      password:key,
      timeout:20,
      keepAliveInterval:60,
      onSuccess:function(){
        connected=true;
        setStatus("Connected","lightgreen");
        log("✅ Connected. Subscribing to "+topic,"log-connected");
        client.subscribe(topic,{qos:0});
      },
      onFailure:function(err){
        setStatus("Connect failed","red");
        log("❌ Connection failed: "+(err.errorMessage||JSON.stringify(err)),"log-error");
      }
    };

    setStatus("Connecting…","orange");
    log("Attempting connect with options: "+JSON.stringify({userName:username,useSSL:true,path:path,port:port}));
    try{ client.connect(options); }
    catch(e){ log("💥 Exception during connect: "+e,"log-error"); }
  }

  connectBtn.addEventListener("click",connect);

  buttonsDiv.querySelectorAll("button").forEach(btn=>{
    btn.addEventListener("click",function(){
      if(!connected){ alert("Not connected"); return; }
      const username=userInput.value.trim();
      const feed=feedInput.value.trim();
      const topic=username+"/feeds/"+feed;
      const payload=btn.dataset.msg;
      const message=new Paho.MQTT.Message(payload);
      message.destinationName=topic;
      try{ client.send(message); log("➡️ Published => "+topic+": "+payload,"log-connected"); }
      catch(e){ log("💥 Exception during publish: "+e,"log-error"); }
    });
  });

  window.onerror=function(msg,url,line,col,err){ log("💥 Uncaught error: "+msg+" at "+line+":"+col,"log-error"); };
})();
</script>
</body>
</html>
